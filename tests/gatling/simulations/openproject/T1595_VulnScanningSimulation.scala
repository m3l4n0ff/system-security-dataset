package openproject

import io.gatling.core.Predef._
import io.gatling.http.Predef._
import scala.concurrent.duration._

class T1595_VulnScanningSimulation extends Simulation {

  val baseUrl = sys.props.getOrElse("baseUrl", "http://localhost:8080")
  val attackDuration = sys.props.getOrElse("duration", "180").toInt.seconds

  val httpProtocol = http
    .baseUrl(baseUrl)
    .acceptHeader("text/html,application/json,*/*")
    .userAgentHeader("Nikto/2.5.0")

  // --- Scenario 1: Sensitive file probing ---
  val sensitiveFiles = scenario("T1595 - Sensitive Files")
    .exec(http("Scan - .env").get("/.env"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - .env.bak").get("/.env.bak"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - .git/config").get("/.git/config"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - .git/HEAD").get("/.git/HEAD"))
    .pause(200.milliseconds)
    .exec(http("Scan - .gitignore").get("/.gitignore"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - .htaccess").get("/.htaccess"))
    .pause(200.milliseconds)
    .exec(http("Scan - .htpasswd").get("/.htpasswd"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - .svn/entries").get("/.svn/entries"))
    .pause(200.milliseconds)
    .exec(http("Scan - .DS_Store").get("/.DS_Store"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - robots.txt").get("/robots.txt"))
    .pause(200.milliseconds)
    .exec(http("Scan - sitemap.xml").get("/sitemap.xml"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - crossdomain.xml").get("/crossdomain.xml"))
    .pause(200.milliseconds)
    .exec(http("Scan - security.txt").get("/.well-known/security.txt"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - Dockerfile").get("/Dockerfile"))
    .pause(200.milliseconds)
    .exec(http("Scan - docker-compose").get("/docker-compose.yml"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - id_rsa").get("/.ssh/id_rsa"))
    .pause(200.milliseconds)
    .exec(http("Scan - aws creds").get("/.aws/credentials"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - npmrc").get("/.npmrc"))
    .pause(200.milliseconds)

  // --- Scenario 2: Backup / CMS / Config probes ---
  val backupsAndCMS = scenario("T1595 - Backups & CMS")
    .exec(http("Scan - backup.sql").get("/backup.sql"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - db.sql").get("/db.sql"))
    .pause(200.milliseconds)
    .exec(http("Scan - dump.sql").get("/dump.sql"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - database.sql.gz").get("/database.sql.gz"))
    .pause(200.milliseconds)
    .exec(http("Scan - backup.tar.gz").get("/backup.tar.gz"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - backup.zip").get("/backup.zip"))
    .pause(200.milliseconds)
    .exec(http("Scan - wp-admin").get("/wp-admin/"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - wp-login").get("/wp-login.php"))
    .pause(200.milliseconds)
    .exec(http("Scan - wp-config").get("/wp-config.php"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - wp-cron").get("/wp-cron.php"))
    .pause(200.milliseconds)
    .exec(http("Scan - phpinfo").get("/phpinfo.php"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - info.php").get("/info.php"))
    .pause(200.milliseconds)
    .exec(http("Scan - phpmyadmin").get("/phpmyadmin/"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - adminer").get("/adminer.php"))
    .pause(200.milliseconds)
    .exec(http("Scan - elmah").get("/elmah.axd"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - web.config").get("/web.config"))
    .pause(200.milliseconds)
    .exec(http("Scan - server-status").get("/server-status"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - server-info").get("/server-info"))
    .pause(200.milliseconds)

  // --- Scenario 3: Admin / debug endpoint probing ---
  val adminEndpoints = scenario("T1595 - Admin Endpoints")
    .exec(http("Scan - /admin").get("/admin"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - /admin/info").get("/admin/info"))
    .pause(200.milliseconds)
    .exec(http("Scan - /admin/plugins").get("/admin/plugins"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - /admin/settings").get("/admin/settings"))
    .pause(200.milliseconds)
    .exec(http("Scan - /admin/users").get("/admin/users"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - /console").get("/console"))
    .pause(200.milliseconds)
    .exec(http("Scan - /rails/info").get("/rails/info"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - /rails/mailers").get("/rails/mailers"))
    .pause(200.milliseconds)
    .exec(http("Scan - /sidekiq").get("/sidekiq"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - /debug").get("/debug"))
    .pause(200.milliseconds)
    .exec(http("Scan - /trace").get("/trace"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - /actuator").get("/actuator"))
    .pause(200.milliseconds)
    .exec(http("Scan - /actuator/env").get("/actuator/env"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - /actuator/health").get("/actuator/health"))
    .pause(200.milliseconds)
    .exec(http("Scan - /metrics").get("/metrics"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - /graphql").get("/graphql"))
    .pause(200.milliseconds)
    .exec(http("Scan - /api/swagger").get("/api/swagger"))
    .pause(200.milliseconds, 500.milliseconds)
    .exec(http("Scan - /api/docs").get("/api/docs"))
    .pause(200.milliseconds)

  setUp(
    sensitiveFiles.inject(atOnceUsers(1)),
    backupsAndCMS.inject(nothingFor(2.seconds), atOnceUsers(1)),
    adminEndpoints.inject(nothingFor(4.seconds), atOnceUsers(1))
  ).protocols(httpProtocol).maxDuration(attackDuration + 30.seconds)
}
